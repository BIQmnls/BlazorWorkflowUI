@page "/"

@inject IWorkflowService WorkflowService

<MudPaper Class="pa-4">
    <MudTextField T="string" @bind-Value="_workflow.Name" Label="Workflow Name" Variant="Variant.Filled" Class="mb-2" />
    <MudSelect T="string" @bind-Value="_workflow.Trigger.ActivityType" Label="Trigger" Variant="Variant.Filled" Class="mb-2">
        @foreach (var option in _triggerOptions)
        {
            <MudSelectItem Value="@option">@option</MudSelectItem>
        }
    </MudSelect>
    <MudTextField T="string" @bind-Value="_workflow.Trigger.Condition" Label="Condition" Variant="Variant.Filled" Class="mb-4" />

    <MudDivider Class="mb-4" />
    <MudText Typo="Typo.h6">Steps</MudText>
    <MudTable Items="_workflow.Steps" Class="mb-2">
        <HeaderContent>
            <MudTh>Activity</MudTh>
            <MudTh>Delay (s)</MudTh>
            <MudTh>Branches (IDs)</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudSelect T="string" @bind-Value="context.ActivityType">
                    @foreach (var option in _activityOptions)
                    {
                        <MudSelectItem Value="@option">@option</MudSelectItem>
                    }
                </MudSelect>
            </MudTd>
            <MudTd><MudNumericField T="int?" @bind-Value="context.DelaySeconds" /></MudTd>
            <MudTd><MudTextField T="string" @bind-Value="context.Branches" /></MudTd>
        </RowTemplate>
    </MudTable>
    <MudButton OnClick="AddStep" Variant="Variant.Filled" Color="Color.Primary" Class="mb-4">Add Step</MudButton>

    <MudDivider Class="mb-4" />
    <MudButton OnClick="Generate" Variant="Variant.Filled" Color="Color.Secondary" Class="mb-2">Generate JSON</MudButton>
    <MudTextField T="string" @bind-Value="_json" Lines="10" ReadOnly="true" Class="mt-2" />
</MudPaper>

@code {
    protected WorkflowModel _workflow = new();

    protected string? _json;

    private readonly List<string> _triggerOptions = new() { "Start", "Schedule", "Signal" };
    private readonly List<string> _activityOptions = new() { "WriteLine", "SendEmail", "Delay" };

    void AddStep() => _workflow.Steps.Add(new StepModel());

    void Generate() => _json = WorkflowService.GenerateJson(_workflow);
}
